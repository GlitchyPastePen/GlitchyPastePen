<!-- This is a static file -->
<!-- served from your routes in server.js -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Mini Glitch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="A cool thing made with Glitch" />
    <link
      id="favicon"
      rel="icon"
      href="https://glitch.com/edit/favicon-app.ico"
      type="image/x-icon"
    />

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/codemirror@5.52.2/lib/codemirror.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/codemirror@5.52.2/theme/ayu-mirage.css"
    />
    <!--     // https://codemirror.net/addon/lint/lint.css -->
    <link rel="stylesheet" href="/codemirror-theme.css" />
    <link rel="stylesheet" href="https://codemirror.net/addon/lint/lint.css" />
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.52.2/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.52.2/mode/javascript/javascript.js"></script>
    <script src="https://codemirror.net/mode/javascript/javascript.js"></script>
    <script src="https://codemirror.net/mode/css/css.js"></script>
    <script src="https://codemirror.net/mode/htmlmixed/htmlmixed.js"></script>
    <script src="https://codemirror.net/mode/xml/xml.js"></script>
    <script src="https://codemirror.net/addon/lint/lint.js"></script>
    <script src="https://codemirror.net/addon/lint/javascript-lint.js"></script>
    <script src="https://codemirror.net/addon/lint/json-lint.js"></script>
    <script src="https://codemirror.net/addon/lint/html-lint.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jshint/r07/jshint.js"></script>
    <script src="https://rawgithub.com/zaach/jsonlint/79b553fb65c192add9066da64043458981b3972b/lib/jsonlint.js"></script>
    <!--     <script src="/csslint.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/addon/lint/css-lint.min.js"></script>
    <script src="https://codemirror.net/addon/edit/closetag.js"></script>
    <script src="https://codemirror.net/addon/edit/closebrackets.js"></script>
    <script src="https://codemirror.net/addon/edit/matchtags.js"></script>
    <script src="https://codemirror.net/addon/edit/matchbrackets.js"></script>
    <script src="https://codemirror.net/addon/selection/active-line.js"></script>
    <script src="https://codemirror.net/addon/fold/foldcode.js"></script>
    <script src="https://codemirror.net/addon/fold/foldgutter.js"></script>
    <script src="https://codemirror.net/addon/fold/brace-fold.js"></script>
    <script src="https://codemirror.net/addon/fold/xml-fold.js"></script>
    <script src="https://htmlhint.com/js/htmlhint.js"></script>
    <script src="https://codemirror.net/addon/fold/comment-fold.js"></script>
    <script src="/script.js"></script>
  </head>
  <body style="background-color:#1f2430;">
    <header>
      <span id="status">
      </span>
      <button id="logout">
        <a href="/logout">Log out</a>
      </button>
      <p class="p-title">
        <i>PROJECT NAME</i>
      </p>
      <input type="text" id="project-name" />
      <p class="empty">
        <a href="" class="owner"></a>
      </p>
      <button id="deploy" onclick="deploy();" title="Save code!">
        <img
          src="https://img.icons8.com/cotton/100/000000/save.png"
          height="40px"
        />
      </button>
    </header>
    <br /><br />
    <textarea id="editor" oninput="save();"></textarea>

    <script>
      document.CodeMirror = CodeMirror;
      var editor = createEditor(document.getElementById("editor"), {
        lineNumbers: true,
        mode:  "htmlmixed",
        htmlMode: true,
        lint: true,
        theme: "ayu-mirage"
      });
      editor.setSize("100%", "100%");

      let projecturl = window.location.href;
      let projectname = projecturl.slice(41);
      document.getElementById("project-name").value = projectname;

      let name = document.getElementById("project-name").value;
      let path = "/getCode/" + name;
      fetch(path)
        .then(response => response.json())
        .then(data => {
          editor.setValue(data.code);
        });
      
      fetch('/projectinfo/' + projectname)
        .then(response => response.json())
        .then(data => {
          document.getElementsByClassName("owner")[0].innerText = "by " + data.owner;
          document.getElementsByClassName("owner")[0].href = "/u/" + data.owner;
        });

      function deploy() {
        let code = editor.getValue();
        let name = document.getElementById("project-name").value;
        let content = { code: code, name: name };

        fetch("/deploy", {
          method: "post",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(content)
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 200) {
              document.getElementById("status").style.display = "block";
              document.getElementById("status").innerHTML = "Your project has been successfully deployed <br />at https://glitchypastepen.glitch.me/p/" + name;
            } else {
              document.getElementById("status").style.display = "block";
              document.getElementById('status').style.backgroundColor = "red";
              document.getElementById('status').innerHTML = "Something went wrong! <br />Try again?";
            }
          });
      }
    </script>
  </body>
</html>
